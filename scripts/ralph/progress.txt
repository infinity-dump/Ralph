# Ralph Progress Log
Started: 2024-01-15

## Codebase Patterns
- Ralph: Cache module stores patterns, rules, and common errors in .ralph-cache with TTL-based refresh and context injection when RALPH_CACHE=1.
- Ralph: Parallel mode uses git worktrees plus per-story locks and a merge lock to coordinate concurrent stories.
- Ralph: Adversarial review runs when RALPH_ADVERSARIAL=1 and uses RALPH_REVIEWER_CMD or the main agent command.
- Ralph: Quality gates are opt-in and only block when RALPH_QUALITY_GATES=strict; skip checks when tools/files are missing
- Ralph: Circuit breaker module tracks iteration limits, consecutive failures, and stuck story retries
- Ralph: Normalize story selection with jq (priority/status/dependencies) and fall back gracefully when jq is missing
- Ralph: Progress entries must include explicit Gotchas and still be logged on failures
- Ralph: PRD generator should fall back to template output when agent responses are missing or invalid
- Ralph: Prompt templates should include fresh-context anchoring plus a per-iteration quality checklist
- Ralph: Inject a per-iteration context header (git state, optional Codebase Patterns) when RALPH_CONTEXT_SUMMARY=1
- Ralph: Git guard wraps git via PATH and blocks destructive commands unless bypassed
- Ralph: Cost controls honor RALPH_TASK_TYPE for iteration caps, RALPH_RATE_LIMIT for pacing, and phase metadata (phase/phases/tags) for chaining.
- Ralph: Agent presets set default commands, input modes, and prompt context; model limits use normalized agent names.
- Ralph: Init should seed prd/prompt/progress files from templates and skip existing files unless forced.
- Ralph: Test-driven mode detects test runners from project files, injects failing test context, and tracks pass/total counts per iteration.
- Migrations: IF NOT EXISTS
- Types: Export from actions.ts

## Key Files
- db/schema.ts
- app/auth/actions.ts
---

## 2026-01-11 - US-001
- Implemented priority/status/dependency-aware story selection in `ralph.sh` and injected the selected story into the prompt.
- Updated `prd.json` stories to use numeric priority, dependencies arrays, and status fields.
- **Learnings:**
  - Normalize legacy priority strings to numeric values for backward compatibility.
  - Guard jq usage so the loop still runs when jq is unavailable.
---

## 2026-01-11 - US-002
- Implemented circuit breakers for iteration limits, consecutive failures, warnings, and stuck-story detection.
- Files changed: scripts/ralph/ralph.sh, scripts/ralph/modules/circuit-breaker.sh, scripts/ralph/prd.json, scripts/ralph/progress.txt
- **Learnings:**
  - Use a temp prompt file and PIPESTATUS to capture agent output plus exit status reliably.
  - Reset stuck-story counters on successful iterations to avoid false escalations.
---

## 2026-01-11 - US-003
- Implemented the quality gates module with language checks, PRD validation, and optional test auto-detection.
- Files changed: scripts/ralph/modules/quality-gates.sh, scripts/ralph/ralph.sh, scripts/ralph/prd.json, scripts/ralph/progress.txt
- **Learnings:**
  - Keep quality gates non-blocking unless strict mode is explicitly enabled.
  - Prefer local tool binaries (like node_modules/.bin/tsc) before falling back to global installs.
---

## 2026-01-11 - US-005
- Clarified progress.txt format to include explicit Gotchas and failure logging requirements.
- Files changed: scripts/ralph/prompt.md, scripts/ralph/templates/progress-template.txt
- **Learnings:**
  - Include a dedicated Gotchas section for each progress entry.
- **Gotchas:**
  - Keep Codebase Patterns at the top of progress.txt to preserve cross-iteration memory.
---

## 2026-01-11 - US-006
- Implemented a PRD generator module with template-based story breakdown and optional agent-assisted generation.
- Files changed: scripts/ralph/modules/prd-generator.sh, scripts/ralph/ralph.sh, scripts/ralph/prd.json, scripts/ralph/progress.txt, AGENTS.md
- **Learnings:**
  - Validate agent-generated PRDs as JSON and fall back to a local template when invalid.
- **Gotchas:**
  - Avoid nested heredoc delimiters that collide when embedding prompts.
---

## 2026-01-11 - US-017
- Refreshed `prompt.md` with explicit workflow, fresh-context anchoring, and quality checklist guidance.
- Added `templates/prompt-template.md` to keep new projects aligned with the improved prompt structure.
- Files changed: scripts/ralph/prompt.md, scripts/ralph/templates/prompt-template.md, scripts/ralph/progress.txt, AGENTS.md, scripts/ralph/prd.json
- **Learnings:**
  - Prompt templates should mirror the runtime prompt to keep new setups consistent.
- **Gotchas:**
  - Use distinct heredoc delimiters when embedding examples to avoid shell parsing errors.
---

## 2026-01-11 - US-004
- Added a per-iteration context header (timestamp, git state) and optional Codebase Patterns injection via RALPH_CONTEXT_SUMMARY=1.
- Enforced progress.txt presence each iteration and updated prompt guidance to treat injected context as authoritative.
- Files changed: scripts/ralph/ralph.sh, scripts/ralph/prompt.md, scripts/ralph/templates/prompt-template.md, scripts/ralph/progress.txt, AGENTS.md
- Typecheck/tests: not run (no test config found).
- **Learnings:**
  - Fresh context is clearer when the loop prepends timestamped git status and optional patterns.
- **Gotchas:**
  - Keep prompt templates in sync with prompt.md when adjusting injected context.
---

## 2026-01-11 - US-007
- Added a planning-phase module that writes `.ralph-plan.md`, supports optional self-review, and gates execution with manual approval.
- Wired the planning phase into `ralph.sh` and documented the workflow in the prompt instructions/templates.
- Files changed: scripts/ralph/modules/planner.sh, scripts/ralph/ralph.sh, scripts/ralph/prompt.md, scripts/ralph/templates/prompt-template.md, scripts/ralph/prd.json
- **Learnings:**
  - Capture plan output into `.ralph-plan.md` so the plan exists even if the agent doesn't save it explicitly.
- **Gotchas:**
  - Manual approval needs a non-interactive escape hatch (env var or `.approved` file) to avoid blocking loop runs.
---

## 2026-01-11 - US-008
- Added adversarial reviewer module and wired it into ralph.sh behind RALPH_ADVERSARIAL.
- Reviewer uses a critic prompt, includes git status/diff stats, and honors RALPH_REVIEWER_CMD overrides.
- Files changed: scripts/ralph/modules/reviewer.sh, scripts/ralph/ralph.sh, scripts/ralph/prd.json, scripts/ralph/progress.txt, AGENTS.md
- Typecheck/tests: not run (no test config found).
- **Learnings:**
  - Adversarial review should stay non-blocking while surfacing critique via a separate prompt.
- **Gotchas:**
  - Ensure reviewer defaults to the main agent command unless RALPH_REVIEWER_CMD is set.
---

## 2026-01-11 - US-014
- Implemented a git-guard module that wraps git to block destructive commands and honors bypass flags.
- Wired git-guard into ralph.sh so it activates when RALPH_GIT_GUARD=1.
- Files changed: scripts/ralph/modules/git-guard.sh, scripts/ralph/ralph.sh, scripts/ralph/prd.json, scripts/ralph/progress.txt
- Typecheck/tests: not run (no test config found).
- **Learnings:**
  - Wrapping git via PATH is a simple way to guard agent-initiated commands.
- **Gotchas:**
  - Keep the guard permissive for non-destructive git usage so core loop status checks keep working.
---

## 2026-01-12 - US-009
- Implemented parallel execution via git worktrees with per-story locks, status tracking, and merge coordination.
- Wired RALPH_PARALLEL to launch parallel worktrees and added single-story targeting for worker runs.
- Files changed: scripts/ralph/modules/parallel.sh, scripts/ralph/ralph.sh, scripts/ralph/prd.json, scripts/ralph/progress.txt, AGENTS.md
- Typecheck/tests: bash -n scripts/ralph/ralph.sh scripts/ralph/modules/parallel.sh
- **Learnings:**
  - Use per-story lock dirs plus a merge lock to avoid concurrent worktree/merge conflicts.
- **Gotchas:**
  - Parallel workers must disable RALPH_PARALLEL and run in single-story mode to avoid recursive worktree spawning.
---

## 2026-01-12 - US-010
- Implemented checkpoint persistence to `.ralph-checkpoint.json` with failure metadata and resume support.
- Wired RALPH_CHECKPOINT auto-checkpointing, --resume handling, and checkpoint cleanup on successful completion.
- Files changed: scripts/ralph/modules/checkpoint.sh, scripts/ralph/ralph.sh, scripts/ralph/prd.json, scripts/ralph/progress.txt, AGENTS.md
- Typecheck/tests: bash -n scripts/ralph/ralph.sh scripts/ralph/modules/checkpoint.sh
- **Learnings:**
  - Checkpoint writes should escape JSON without requiring jq so resume works in minimal environments.
- **Gotchas:**
  - Avoid nested heredoc delimiter collisions when embedding JSON writers in shell modules.
---

## 2026-01-12 - US-011
- Added a persistent cache module that stores patterns, rules, and common errors and injects cached context when RALPH_CACHE=1.
- Wired cache refresh into ralph.sh with TTL/manual clear handling.
- Files changed: scripts/ralph/modules/cache.sh, scripts/ralph/ralph.sh, scripts/ralph/prd.json, scripts/ralph/progress.txt, AGENTS.md
- Typecheck/tests: bash -n scripts/ralph/ralph.sh scripts/ralph/modules/cache.sh
- **Learnings:**
  - Cache refresh should be TTL-based with manual clear to keep cold data stable.
- **Gotchas:**
  - Cache logging must go to stderr to avoid polluting injected prompt context.
---

## 2026-01-12 - US-012
- Implemented cost control module for budget tracking, task-type iteration caps, rate limiting, and phase chaining with verification hooks.
- Wired cost controls into the main loop (phase gating, budget enforcement, rate-limited sleeps, exit cost summary).
- Files changed: scripts/ralph/modules/cost-control.sh, scripts/ralph/ralph.sh, scripts/ralph/prd.json, scripts/ralph/progress.txt, AGENTS.md
- Typecheck/tests: bash -n scripts/ralph/ralph.sh scripts/ralph/modules/cost-control.sh
- **Learnings:**
  - Budget enforcement needs explicit cost signals (env, tracker cmd, or agent output) to be reliable.
- **Gotchas:**
  - Phase chaining relies on jq plus phase metadata (phase/phases/tags); otherwise gating is skipped.
---

## 2026-01-12 - US-015
- Added agent presets for codex/claude/aider, with per-agent input modes and prompt context injection.
- Wired agent normalization into model limit detection and preset validation.
- Files changed: scripts/ralph/ralph.sh, scripts/ralph/prd.json, scripts/ralph/progress.txt, AGENTS.md
- Typecheck/tests: bash -n scripts/ralph/ralph.sh (no test config found)
- **Learnings:**
  - Normalize agent names before applying model-specific iteration limits.
- **Gotchas:**
  - Custom agent commands keep stdin semantics; use presets when file-based input is required.
---

## 2026-01-12 - US-018
- Added a PRD template with example atomic stories and an init command to seed prd/prompt/progress files from templates.
- Files changed: scripts/ralph/ralph.sh, scripts/ralph/templates/prd-template.json, scripts/ralph/prd.json, scripts/ralph/progress.txt, AGENTS.md
- Typecheck/tests: bash -n scripts/ralph/ralph.sh (no test config found).
- **Learnings:**
  - Init should copy template content into working files and avoid overwriting without --force.
- **Gotchas:**
  - Run init in new repos before starting the loop so prd/prompt/progress files exist.
---

## 2026-01-12 - US-019
- Added structured iteration banners, story display, quality gate summaries, and end-of-run reporting (iterations, completed stories, elapsed time, cost estimate).
- Implemented optional verbose logging, log-file teeing via RALPH_LOG, and exit summaries with stuck-story analysis.
- Files changed: scripts/ralph/ralph.sh, scripts/ralph/prd.json, scripts/ralph/progress.txt, AGENTS.md
- Typecheck/tests: bash -n scripts/ralph/ralph.sh
- **Learnings:**
  - Loop-level logging benefits from centralized helpers and exit summaries to keep output consistent.
- **Gotchas:**
  - When teeing output to RALPH_LOG, avoid double-printing agent output by adjusting the tee pipeline.
---

## 2026-01-12 - US-019
- Confirmed logging features (iteration banners, story display, quality gate status, exit summary) and marked the story complete in `prd.json`.
- Files changed: scripts/ralph/prd.json, AGENTS.md, scripts/ralph/progress.txt
- Typecheck/tests: bash -n scripts/ralph/ralph.sh
- **Learnings:**
  - RALPH_VERBOSE can surface story metadata and iteration timing without changing default output.
- **Gotchas:**
  - Log teeing should avoid duplicating agent output when RALPH_LOG is set.
---

## 2026-01-12 - US-020
- Implemented test-driven loop mode in `ralph.sh`, including test runner detection, pre/post test runs, and test-focused prompt context.
- Added test progress logging with pass/total counts and completion based on the test suite passing.
- Files changed: scripts/ralph/ralph.sh, scripts/ralph/prd.json, scripts/ralph/progress.txt, AGENTS.md
- Typecheck/tests: bash -n scripts/ralph/ralph.sh
- **Learnings:**
  - Test mode benefits from re-detecting the runner each iteration to pick up newly added configs.
- **Gotchas:**
  - Donâ€™t treat a previously detected test command as an override; re-scan project files to avoid stale runners.
---
